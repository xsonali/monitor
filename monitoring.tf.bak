# Original resource group for your firewall and main infra
resource "azurerm_resource_group" "hub-vnet-rg" {
  name     = "hub-vnet-rg-m617"
  location = "australiaeast"
}

# New resource group for logs and monitoring
resource "azurerm_resource_group" "rg_logs" {
  name     = "rg-hub-logs"
  location = "australiaeast"
}

# Data source to reference your existing Azure Firewall
data "azurerm_resource_group" "hub-vnet-rg-m617" {
  name                = "hub-vnet-rg-m617"
  resource_group_name = azurerm_resource_group.hub-vnet-rg-m617.name
}

# Log Analytics workspace (in logs RG)
resource "azurerm_log_analytics_workspace" "hub_logs" {
  name                = "hub-fw-logs"
  location            = azurerm_resource_group.rg_logs.location
  resource_group_name = azurerm_resource_group.rg_logs.name
  sku                 = "PerGB2018"
  retention_in_days   = 30

  tags = {
    environment = "hub-vnet"
    createdBy   = "terraform"
    owner       = "Gholam"
  }
}

# Diagnostic Settings sending Azure Firewall logs to Log Analytics in separate RG
resource "azurerm_monitor_diagnostic_setting" "fw_logs" {
  name                       = "fw-diagnostics"
  target_resource_id         = data.azurerm_firewall.hub_fw.id
  log_analytics_workspace_id = azurerm_log_analytics_workspace.hub_logs.id

  enabled_log {
    category = "AzureFirewallApplicationRule"
  }
  enabled_log {
    category = "AzureFirewallNetworkRule"
  }
  enabled_log {
    category = "AzureFirewallDnsProxy"
  }

  metric {
    category = "AllMetrics"
    enabled  = true
  }
}

# Microsoft Sentinel onboarding on Log Analytics workspace
resource "azurerm_sentinel_log_analytics_workspace_onboarding" "hub_logs" {
  workspace_id = azurerm_log_analytics_workspace.hub_logs.id
}

# Sentinel Scheduled Alert (same workspace)
resource "azurerm_sentinel_alert_rule_scheduled" "rdp_spike" {
  depends_on = [
    azurerm_sentinel_log_analytics_workspace_onboarding.hub_logs
  ]

  name                       = "High RDP Traffic Detected"
  log_analytics_workspace_id = azurerm_log_analytics_workspace.hub_logs.id
  display_name               = "High RDP Traffic Detected"
  severity                   = "High"
  query                      = <<QUERY
SecurityEvent
| where EventID == 4625 and AccountType == "User"
QUERY
  query_frequency            = "PT1H"
  query_period               = "PT1H"
  trigger_operator           = "GreaterThan"
  trigger_threshold          = 5
}
